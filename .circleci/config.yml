version: 2
jobs:

  build:
    docker:
      - image: mrseccubus/github-pages:latest
    steps:
#      - run: apt-get update && apt-get install -y ssh git
      - run: (cd /root/;rm -rf project;mkdir project)
      - checkout
      - run:
          name: Build site
          command: |
            jekyll build
      - store_artifacts:
          path: /root/project/_site/
      - save_cache:
          key: jekyll-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - "/root/project/_site"


  upload:
    docker:
      - image: alpine:latest
    steps:
      - run:
          name: Install software
          command: |
            apk update;
            apk add lftp;
            echo "ftp:passive-mode true" > ~/.lftprc
      - restore_cache:
          key: jekyll-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          name: Upload
          command: |
            cd /root/project/_site;
            lftp -u www-abuse --env-password upload.bit.nl << EOF
              cd htdocs
              mirror --continue --reverse --delete --verbose --exclude=serve
              bye
            EOF            



workflows:
  version: 2
  build_and_upload:
    jobs:
      - build
      - upload:
          requires:
            - build
          filters:
            branches:
              only:
                - master
                - circleci-test
